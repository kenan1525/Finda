 <!DOCTYPE html>
{% load static %}
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finda AI - Akƒ±llƒ± Arama</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'core/css/home.css' %}">
    <style>
        /* Single page flow */
        .section-box { margin: 20px 0; }

        /* Product Cards - Minimal */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 16px; }
        .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; transition: all 0.2s; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); border-color: #2563eb; }
        .product-image { width: 100%; height: 140px; object-fit: cover; background: #f5f5f5; display: flex; align-items: center; justify-content: center; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 10px; }
        .product-title { font-size: 13px; font-weight: 600; color: #1f2937; line-height: 1.3; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-price { font-size: 14px; font-weight: 700; color: #2563eb; margin-bottom: 6px; }
        .product-store { font-size: 11px; color: #6b7280; margin-bottom: 6px; }
        .product-rating { font-size: 12px; color: #f59e0b; margin-bottom: 8px; }
        .product-link { display: inline-block; padding: 6px 12px; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .product-link:hover { background: #1d4ed8; }
        .product-search-btn { display: inline-block; margin-left: 8px; padding: 6px 10px; background: #eef2ff; color: #1f2937; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: 600; border: 1px solid #e6e9f8; }
        .product-search-btn:hover { background: #e0e7ff; }

        /* Flight Results */
        .flight-form-box { background: white; padding: 16px; border-radius: 8px; margin: 12px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .flight-form-box h3 { margin-bottom: 12px; font-size: 16px; }
        .flight-form { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .flight-form-group { display: flex; flex-direction: column; gap: 4px; }
        .flight-form-group label { font-size: 12px; font-weight: 600; color: #666; }
        .flight-form-group input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .flight-form button { padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; }
        .flight-form button:hover { background: #1d4ed8; }

        /* Flight List */
        .flights-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .flight-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; transition: all 0.2s; }
        .flight-row:hover { background: #f9fafb; border-color: #2563eb; }
        
        .flight-airline { flex: 1; min-width: 80px; font-weight: 600; font-size: 13px; }
        .flight-times { flex: 1.7; min-width: 150px; font-size: 14px; font-weight: 600; }
        .flight-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; font-size: 11px; font-weight: 500; color: #6b7280; }
        .flight-meta span { background: #f8fafc; border: 1px solid #e2e8f0; padding: 2px 6px; border-radius: 6px; }
        .flight-duration { flex: 0.8; min-width: 60px; text-align: center; font-size: 12px; color: #666; }
        .flight-route { flex: 0.8; min-width: 70px; text-align: center; font-size: 12px; color: #666; }
        .flight-price { flex: 1; min-width: 100px; text-align: right; font-size: 16px; font-weight: 700; color: #2563eb; }

        /* Alerts */
        .alert { padding: 12px 14px; border-radius: 6px; margin: 12px 0; font-size: 14px; }
        .alert-info { background: #dbeafe; border: 1px solid #93c5fd; color: #0c4a6e; }
        .alert.error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }

        /* Form styles */
        .search-input-group { display: flex; gap: 8px; margin: 16px 0; }
        .search-input-group input { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .search-input-group button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .search-input-group button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <!-- HEADER -->
       <div class="header">
        <div class="logo">
            <i class="fas fa-shopping-bag"></i>
            <span>Finda AI</span>
        </div>
        <button class="new-chat-btn" onclick="window.location.href='/?new_chat=true'">
            <i class="fas fa-plus"></i> Yeni Sohbet
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- FLIGHT SECTION (shown after flight intent or flight search) -->
        {% if show_flight_section or flight_intent_detected or flight_results %}
        <div class="section-box">
            <div class="flight-form-box">
                <h3>‚úàÔ∏è U√ßu≈ü Ara</h3>
                <form method="post" action="{% url 'home' %}" class="flight-form" id="flight-form">
                    {% csrf_token %}
                    <div class="flight-form-group">
                        <label>Kalkƒ±≈ü (IATA)</label>
                        <input type="text" name="origin" placeholder="IST" maxlength="3" value="{{ flight_form_data.origin }}" required>
                    </div>
                    <div class="flight-form-group">
                        <label>Varƒ±≈ü (IATA)</label>
                        <input type="text" name="destination" placeholder="ANK" maxlength="3" value="{{ flight_form_data.destination }}" required>
                    </div>
                    <div class="flight-form-group">
                        <label>Tarih</label>
                        <input type="text" name="date" placeholder="YYYY-MM-DD" value="{{ flight_form_data.date }}" required>
                    </div>
                    <div class="flight-form-group">
                        <label>Yolcu</label>
                        <input type="number" name="adults" min="1" value="{{ flight_form_data.adults|default:'1' }}">
                    </div>
                    <button type="submit">Ara</button>
                </form>
            </div>

            <!-- FLIGHT RESULTS -->
            {% if flight_results %}
            <div id="flight-results" style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                {% if flight_results.error %}
                <div class="alert error">
                    <strong>Hata:</strong> {{ flight_results.error }}
                </div>
                {% elif flight_results.data %}
                <h3 style="margin-bottom: 12px;">{{ flight_results.data|length }} U√ßu≈ü Bulundu</h3>
                <div class="flights-list">
                    {% for offer in flight_results.data %}
                    <div class="flight-row">
                        <div class="flight-airline">
                            {% if offer.validatingAirlineCodes %}
                            {{ offer.validatingAirlineCodes.0 }}
                            {% else %}
                            Airline
                            {% endif %}
                        </div>

                        <div class="flight-times">
                            {% if offer.itineraries.0.segments.0 %}
                            {{ offer.itineraries.0.segments.0.departure.at|slice:"11:16" }} ‚Üí 
                            {% with seg=offer.itineraries.0.segments|last %}
                            {{ seg.arrival.at|slice:"11:16" }}
                            {% endwith %}
                            {% endif %}
                            <div class="flight-meta">
                                {% if offer.validatingAirlineCodes %}
                                <span>Firma: {{ offer.validatingAirlineCodes.0 }}</span>
                                {% endif %}
                                {% if offer.itineraries.0.segments.0 %}
                                <span>U√ßu≈ü: {{ offer.itineraries.0.segments.0.carrierCode }}{{ offer.itineraries.0.segments.0.number }}</span>
                                {% endif %}
                                {% if offer.itineraries.0.segments %}
                                <span>Aktarma: {{ offer.itineraries.0.segments|length|add:"-1" }}</span>
                                {% endif %}
                                {% if offer.travelerPricings.0.fareDetailsBySegment.0.cabin %}
                                <span>Kabin: {{ offer.travelerPricings.0.fareDetailsBySegment.0.cabin }}</span>
                                {% endif %}
                                {% if offer.travelerPricings.0.fareDetailsBySegment.0.includedCheckedBags %}
                                <span>Bagaj:
                                    {% if offer.travelerPricings.0.fareDetailsBySegment.0.includedCheckedBags.weight %}
                                    {{ offer.travelerPricings.0.fareDetailsBySegment.0.includedCheckedBags.weight }}{{ offer.travelerPricings.0.fareDetailsBySegment.0.includedCheckedBags.weightUnit }}
                                    {% elif offer.travelerPricings.0.fareDetailsBySegment.0.includedCheckedBags.quantity %}
                                    {{ offer.travelerPricings.0.fareDetailsBySegment.0.includedCheckedBags.quantity }} par√ßa
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="flight-duration">
                            {% if offer.itineraries.0.duration %}
                            {{ offer.itineraries.0.duration|slice:"2:" }}
                            {% else %}
                            --
                            {% endif %}
                        </div>

                        <div class="flight-route">
                            {% if offer.itineraries.0.segments.0 %}
                            {{ offer.itineraries.0.segments.0.departure.iataCode }} ‚Üí 
                            {% with seg=offer.itineraries.0.segments|last %}
                            {{ seg.arrival.iataCode }}
                            {% endwith %}
                            {% endif %}
                        </div>

                        <div class="flight-price">
                            {% if offer.price.total %}
                            {{ offer.price.total }} {{ offer.price.currency }}
                            {% else %}
                            --
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p style="text-align: center; color: #666; padding: 20px;">U√ßu≈ü bulunamadƒ±.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- PRODUCT + CHAT SECTION -->
        <div class="section-box">
            {% if flight_intent_detected %}
            <div class="alert alert-info">
                <strong>‚úàÔ∏è U√ßu≈ü mu arƒ±yorsunuz?</strong> "{{ flight_query }}" u√ßu≈ü ile ilgili g√∂r√ºn√ºyor. U√ßu≈ü sekmesinden detaylƒ± arama yapabilirsiniz.
            </div>
            {% endif %}

            {% if not chat_history and not show_flight_section and not flight_intent_detected %}
            <div class="welcome-screen">
                <h1>üëã Merhaba!</h1>
                <p>Size nasƒ±l yardƒ±mcƒ± olabilirim?</p>
                <div class="suggestions">
                    <div class="suggestion-card" onclick="document.querySelector('#product-search-input').value='en iyi telefon modelleri';document.querySelector('#product-form').submit();">üì± Telefon</div>
                    <div class="suggestion-card" onclick="document.querySelector('#product-search-input').value='ucuz laptop';document.querySelector('#product-form').submit();">üíª Laptop</div>
                    <div class="suggestion-card" onclick="document.querySelector('#product-search-input').value='kulaklƒ±k';document.querySelector('#product-form').submit();">üéß Kulaklƒ±k</div>
                    <div class="suggestion-card" onclick="document.querySelector('#product-search-input').value='ayakkabƒ±';document.querySelector('#product-form').submit();">üëü Ayakkabƒ±</div>
                </div>
            </div>
            {% else %}
            <div class="chat-container">
                {% for message in chat_history %}
                <div class="chat-message {{ message.role }}">
                    <div class="message-avatar">
                        {% if message.role == "user" %}
                        <i class="fas fa-user"></i>
                        {% else %}
                        <i class="fas fa-robot"></i>
                        {% endif %}
                    </div>
                    <div class="message-bubble">{{ message.content }}</div>
                </div>

                {% if message.role == "assistant" and message.products %}
                <div class="products-section">
                    <div class="products-grid">
                        {% for product in message.products %}
                        <div class="product-card">
                            {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.title }}" class="product-image">
                            {% else %}
                            <div class="product-image"><i class="fas fa-image" style="font-size:32px;color:#ccc;"></i></div>
                            {% endif %}
                            <div class="product-info">
                                <div class="product-title">{{ product.title }}</div>
                                <div class="product-price">{{ product.price }}</div>
                                <div class="product-store">{{ product.site|default:"Store" }}</div>
                                {% if product.rating %}
                                <div class="product-rating">‚≠ê {{ product.rating }}</div>
                                {% endif %}
                                {% if product.tags %}
                                <div class="product-tags">
                                    {% for tag in product.tags %}
                                    <span class="ai-tag {% if 'fiyat' in tag|lower %}tag-price{% elif 'puan' in tag|lower %}tag-rating{% elif 'yorum' in tag|lower %}tag-reviews{% else %}tag-price{% endif %}">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if product.link %}
                                <a href="{{ product.link }}" target="_blank" class="product-link">ƒ∞ncele</a>
                                {% endif %}
                                {% if product.title %}
                                <a href="javascript:void(0)" class="product-search-btn" onclick="searchProductBySameBrand('{{ product.title|escapejs }}','{{ product.site|escapejs }}')" title="Aynƒ± √ºr√ºn√º farklƒ± maƒüazalardan g√∂ster">Ara</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% if message.ai_summary and message.ai_summary.data and message.ai_summary.data.commentary %}
                <div class="ai-summary">
                    <div class="ai-title">AI Yorumu</div>
                    <div class="ai-text">{{ message.ai_summary.data.commentary }}</div>
                </div>
                {% endif %}
                {% if message.compare_products %}
                <div class="products-section compare-section" id="compare-section-{{ forloop.counter }}" style="margin-top:14px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-weight:700;color:#111">Aynƒ± √ºr√ºn√º farklƒ± maƒüazalardan (kar≈üƒ±la≈ütƒ±rma)</div>
                        <div style="font-size:12px;color:#6b7280">{{ message.compare_products|length }} teklif</div>
                    </div>
                    <div class="products-grid">
                        {% for product in message.compare_products %}
                        <div class="product-card">
                            {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.title }}" class="product-image">
                            {% else %}
                            <div class="product-image"><i class="fas fa-image" style="font-size:32px;color:#ccc;"></i></div>
                            {% endif %}
                            <div class="product-info">
                                <div class="product-title">{{ product.title }}</div>
                                <div class="product-price">{{ product.price }}</div>
                                <div class="product-store">{{ product.site|default:"Store" }}</div>
                                {% if product.rating %}
                                <div class="product-rating">‚≠ê {{ product.rating }}</div>
                                {% endif %}
                                {% if product.tags %}
                                <div class="product-tags">
                                    {% for tag in product.tags %}
                                    <span class="ai-tag {% if 'fiyat' in tag|lower %}tag-price{% elif 'puan' in tag|lower %}tag-rating{% elif 'yorum' in tag|lower %}tag-reviews{% else %}tag-price{% endif %}">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if product.link %}
                                <a href="{{ product.link }}" target="_blank" class="product-link">ƒ∞ncele</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% if message.compare_ai_summary and message.compare_ai_summary.data and message.compare_ai_summary.data.commentary %}
                <div class="ai-summary">
                    <div class="ai-title">AI Yorumu (Kar≈üƒ±la≈ütƒ±rma)</div>
                    <div class="ai-text">{{ message.compare_ai_summary.data.commentary }}</div>
                </div>
                {% endif %}
                {% endif %}
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- PRODUCT SEARCH PROMPT -->
            <div class="prompt-container">
                <form method="post" id="product-form" action="{% url 'home' %}">
                    {% csrf_token %}
                    <div class="quick-actions">
                        <button type="button" class="quick-actions-btn" aria-label="Hƒ±zlƒ± se√ßenekler">+</button>
                        <div class="quick-actions-menu">
                            <button type="button">Barkodla arama</button>
                            <button type="button">Resim ile arama</button>
                        </div>
                    </div>
                    <input type="text" name="query" id="product-search-input" placeholder="Mesaj yazƒ±n...">
                    <button type="submit">‚û§</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <button onclick="closeProductModal()" class="close-btn">&times;</button>
            <div><img id="modalImage" src="" alt=""></div>
            <div class="modal-body">
                <h2 id="modalTitle"></h2>
                <p id="modalPrice" class="price"></p>
                <p id="modalDescription"></p>
                <p id="modalSite"></p>
                <div style="display:flex;gap:8px;margin-top:12px;">
                    <a id="modalLink" target="_blank" class="btn btn-primary">Maƒüazaya Git</a>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'core/js/home.js' %}"></script>
    <script>
        // Single page flow (no tabs)
        {% if flight_scroll %}
        const flightResults = document.getElementById('flight-results');
        if (flightResults) {
            setTimeout(() => {
                flightResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 120);
        }
        {% endif %}
    </script>
</body>
</html>
     
